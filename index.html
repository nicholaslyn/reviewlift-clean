<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no"/>
<title>ReviewLift — Reviews on Autopilot</title>
<meta name="theme-color" content="#4f46e5"/>
<link rel="manifest" href="manifest.json">
<meta name="mobile-web-app-capable" content="yes">

<style>
  :root{
    --ink:#0f172a; --muted:#6b7280; --bg:#f7f7fb; --panel:#ffffff;
    --brand:#4f46e5; --brand-weak:#eef2ff;
    --radius:14px; --shadow:0 8px 26px rgba(2,8,23,.08);
  }
  @media (prefers-color-scheme: dark){
    :root{ --ink:#e5e7eb; --muted:#94a3b8; --bg:#0b1220; --panel:#0f172a; --brand-weak:#1f2240; }
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font:15px/1.5 Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial}
  a{color:inherit}
  header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,rgba(255,255,255,.86),rgba(255,255,255,.7));backdrop-filter:saturate(1.2) blur(8px);border-bottom:1px solid rgba(2,8,23,.06)}
  .wrap{max-width:1100px;margin:auto;padding:14px}
  .hrow{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .brand{font-weight:900;letter-spacing:.3px}
  nav{display:flex;gap:8px;flex-wrap:wrap}
  .tab{border:1px solid rgba(2,8,23,.1);background:#fff;border-radius:999px;padding:8px 12px;cursor:pointer}
  .tab.active{background:var(--brand);color:#fff;border-color:transparent;box-shadow:var(--shadow)}
  main{display:grid;grid-template-columns:1.2fr .8fr;gap:14px}
  .card{background:var(--panel);border:1px solid rgba(2,8,23,.08);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px}
  h2{margin:0 0 8px 0;font-size:16px}
  .hint{color:var(--muted);font-size:12px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .stack{display:flex;flex-direction:column;gap:10px}
  input,select,textarea,button{border-radius:12px;border:1px solid rgba(2,8,23,.12);background:#fff;color:var(--ink);padding:10px 12px;font:inherit}
  textarea{min-height:90px}
  button{cursor:pointer;transition:transform .18s ease, box-shadow .18s ease}
  button.primary{background:var(--brand);color:#fff;border-color:transparent;box-shadow:0 6px 16px rgba(79,70,229,.25)}
  .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  .kpi{border:1px solid rgba(2,8,23,.08);border-radius:12px;padding:10px;background:#fff}
  .num{font-weight:800;font-size:22px}
  .qr{display:grid;place-items:center;background:#fff;border:1px dashed rgba(2,8,23,.15);border-radius:12px;min-height:260px}
  .public{display:grid;place-items:center;min-height:100vh;background:linear-gradient(180deg,#f7f7fb,#eef2ff)}
  .public .panel{max-width:560px;margin:auto;background:#fff;border:1px solid rgba(2,8,23,.08);border-radius:16px;box-shadow:var(--shadow);padding:18px}
  @media (max-width:960px){main{grid-template-columns:1fr}}
</style>
</head>
<body>
<div id="app"></div>

<script>
const $ = (sel, el=document) => el.querySelector(sel);
const app = document.getElementById('app');

// Router: admin vs public
const hash = location.hash || '#/admin';
if(hash.startsWith('#/p/')) renderPublic();
else renderAdmin();

// Storage / utils
const K = { data:'rl_data_v1', log:'rl_log_v1' };
const S = JSON.parse(localStorage.getItem(K.data) || '{}');
const LOG = JSON.parse(localStorage.getItem(K.log) || '[]');
function save(){ localStorage.setItem(K.data, JSON.stringify(S)); localStorage.setItem(K.log, JSON.stringify(LOG)); }
function b64(o){ return btoa(unescape(encodeURIComponent(JSON.stringify(o)))); }
function ub64(s){ try{ return JSON.parse(decodeURIComponent(escape(atob(s)))); }catch(e){ return null; } }
function defaultMsg(){ return `Hey {firstName}! It was great seeing you today. If we earned your 5★, would you mind leaving a quick review? {link}`; }
function buildPublicLink(){
  const d = { n:S.bizName||'Your Business', c:S.brand||'#4f46e5', l:S.mapsLink||'https://maps.google.com', msg:S.msg||defaultMsg(), logo:S.logo||'' };
  const base = location.origin + location.pathname;
  return base + '#/p/' + b64(d);
}

// ===== Admin UI
function renderAdmin(){
  app.innerHTML = `
<header>
  <div class="wrap hrow">
    <div class="brand">ReviewLift — Reviews on Autopilot</div>
    <nav>
      <button class="tab active" data-tab="setup">Setup</button>
      <button class="tab" data-tab="requests">Requests</button>
      <button class="tab" data-tab="replies">Reply Composer</button>
      <button class="tab" data-tab="dashboard">Dashboard</button>
    </nav>
  </div>
</header>

<main class="wrap" id="tabs">
  <section class="card stack" data-pane="setup">
    <h2>Business Setup</h2>
    <div class="row"><label class="grow">Business name<br><input id="bizName" class="grow" placeholder="Acme Barbers"></label></div>
    <div class="row"><label class="grow">Google Maps / Reviews link<br><input id="mapsLink" class="grow" placeholder="Paste your Google listing link"></label></div>
    <div class="row"><label class="grow">Brand color<br><input id="brand" type="color" value="#4f46e5"></label></div>
    <div class="row"><label class="grow">Default ask message<br><textarea id="msg" placeholder="Hey {firstName}! ... {link}"></textarea></label></div>
    <div class="row">
      <button id="saveSetup" class="primary">Save</button>
      <button id="copyLink">Copy Customer Link</button>
      <button id="showQR">Show QR</button>
      <span class="hint">The link/QR opens your branded review page.</span>
    </div>
    <div id="qrBox" class="qr" style="display:none"><img id="qrImg" alt="QR will appear here"/></div>
  </section>

  <section class="card stack" data-pane="requests" style="display:none">
    <h2>Smart Ask</h2>
    <div class="row">
      <label>Customer first name<br><input id="firstName" placeholder="Sam"></label>
      <label>Visit type<br><input id="visit" placeholder="fade / oil change / cleaning"></label>
    </div>
    <div class="row"><textarea id="msgOut" class="grow" placeholder="Message will appear here..."></textarea></div>
    <div class="row">
      <button id="copySMS" class="primary">Copy SMS</button>
      <button id="copyWhatsApp">Copy WhatsApp</button>
      <button id="copyEmail">Copy Email</button>
      <span class="hint">Paste into your messaging app. Each send logs a request.</span>
    </div>
  </section>

  <section class="card stack" data-pane="replies" style="display:none">
    <h2>Reply Composer</h2>
    <div class="row">
      <label>Customer name<br><input id="rName" placeholder="Sam"></label>
      <label>Stars<br>
        <select id="rStars">
          <option>5</option><option>4</option><option>3</option><option>2</option><option>1</option>
        </select>
      </label>
    </div>
    <div class="row"><textarea id="rText" class="grow" placeholder="Paste their review here (optional)"></textarea></div>
    <div class="row">
      <button class="primary" id="genReply">Generate</button>
    </div>
    <div id="replyList" class="stack"></div>
  </section>

  <section class="card stack" data-pane="dashboard" style="display:none">
    <h2>Dashboard</h2>
    <div class="kpis">
      <div class="kpi"><div class="num" id="kSent">0</div><div class="hint">Requests sent</div></div>
      <div class="kpi"><div class="num" id="kMarked">0</div><div class="hint">Reviews marked</div></div>
      <div class="kpi"><div class="num" id="kConv">0%</div><div class="hint">Conversion (manual)</div></div>
    </div>
    <div class="stack">
      <div class="row">
        <button id="markReview" class="primary">+ Mark a new review</button>
        <button id="exportCSV">Export CSV</button>
        <button id="resetData">Reset</button>
      </div>
      <div class="hint">This V1 tracks sends and reviews locally (manual mark). For cross-device analytics, we can add Supabase later.</div>
    </div>
  </section>
</main>
`;

  // Populate
  $('#bizName').value = S.bizName || '';
  $('#mapsLink').value = S.mapsLink || '';
  $('#brand').value = S.brand || '#4f46e5';
  $('#msg').value = S.msg || defaultMsg();

  // Tabs
  document.querySelectorAll('.tab').forEach(btn=>{
    btn.onclick=()=>{
      document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const pane=btn.dataset.tab;
      document.querySelectorAll('[data-pane]').forEach(p=>p.style.display=(p.dataset.pane===pane)?'block':'none');
    };
  });

  // Save + link/QR
  $('#saveSetup').onclick=()=>{
    S.bizName=$('#bizName').value.trim()||'Your Business';
    S.mapsLink=$('#mapsLink').value.trim()||'https://maps.google.com';
    S.brand=$('#brand').value||'#4f46e5';
    S.msg=$('#msg').value.trim()||defaultMsg();
    save(); alert('Saved.');
  };
  $('#copyLink').onclick=()=>{ navigator.clipboard.writeText(buildPublicLink()).then(()=>alert('Link copied')); };
  $('#showQR').onclick=()=>{
    const box=$('#qrBox'); box.style.display='grid';
    const link=encodeURIComponent(buildPublicLink());
    $('#qrImg').src=`https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${link}`;
  };

  // Smart Ask
  function refreshAsk(){
    const msg=(S.msg||defaultMsg())
      .replace('{firstName}', ($('#firstName').value||'').trim() || 'there')
      .replace('{visit}', ($('#visit').value||'').trim() || 'visit')
      .replace('{link}', buildPublicLink());
    $('#msgOut').value = msg;
  }
  ['firstName','visit'].forEach(id=>$('#'+id).addEventListener('input',refreshAsk));
  refreshAsk();

  function logSend(ch){ LOG.push({type:'send',channel:ch,at:new Date().toISOString(),link:buildPublicLink()}); save(); renderKpis(); }
  $('#copySMS').onclick=()=>{ refreshAsk(); navigator.clipboard.writeText($('#msgOut').value); logSend('sms'); alert('SMS copied'); };
  $('#copyWhatsApp').onclick=()=>{ refreshAsk(); navigator.clipboard.writeText($('#msgOut').value); logSend('whatsapp'); alert('WhatsApp copied'); };
  $('#copyEmail').onclick=()=>{ refreshAsk(); navigator.clipboard.writeText($('#msgOut').value); logSend('email'); alert('Email copied'); };

  // Reply Composer
  $('#genReply').onclick=()=>{
    const name=($('#rName').value||'').trim(), stars=+$('#rStars').value;
    const tone={
      5:[`Thanks${name?`, ${name}`:''}! We’re pumped you loved your visit.`,
         `You made our day${name?`, ${name}`:''}! Thanks for the 5★—we’ll be ready next time.`,
         `Huge thanks${name?`, ${name}`:''}! Reviews like this keep our small business going.`],
      4:[`Thanks so much${name?`, ${name}`:''}! Anything we could do to earn that last star?`,
         `Really appreciate it${name?`, ${name}`:''}. We’re aiming for 5★ next time—thanks!`,
         `Thanks for the review! We’re glad you had a good experience and we’re pushing for great.`],
      3:[`Thanks for the honest feedback${name?`, ${name}`:''}. Mind DM’ing us details?`,
         `We hear you. Please reply so we can make it right.`,
         `Appreciate the notes. We’re working on this and value your detail.`],
      2:[`We’re sorry this missed the mark${name?`, ${name}`:''}. Please contact us so we can fix it—this isn’t our standard.`,
         `Thanks for telling us. We’re addressing this now—could we connect and make it right?`,
         `We dropped the ball here. If you’ll give us another chance, we’d like to make it up to you.`],
      1:[`We’re really sorry, ${name||'friend'}. This isn’t acceptable and we want to fix it—please reach us so we can make it right.`,
         `We hear your frustration and take it seriously. Can we connect to make this right?`,
         `Thank you for flagging this. We’re reviewing with our team immediately—please DM so we can resolve it.`]
    };
    const list=tone[stars]||tone[5]; const host=$('#replyList'); host.innerHTML='';
    list.forEach(s=>{ const p=document.createElement('div'); p.className='card'; p.style.padding='10px'; p.textContent=s;
      const row=document.createElement('div'); row.className='row'; row.style.marginTop='6px';
      const b=document.createElement('button'); b.textContent='Copy'; b.onclick=()=>{ navigator.clipboard.writeText(s); alert('Copied'); };
      row.appendChild(b); p.appendChild(row); host.appendChild(p);
    });
  };

  // Dashboard
  function renderKpis(){
    const sent=LOG.filter(x=>x.type==='send').length;
    const marked=LOG.filter(x=>x.type==='review').length;
    $('#kSent').textContent=sent;
    $('#kMarked').textContent=marked;
    $('#kConv').textContent= sent? Math.round(marked/sent*100)+'%' : '0%';
  }
  renderKpis();
  $('#markReview').onclick=()=>{ LOG.push({type:'review',at:new Date().toISOString()}); save(); renderKpis(); };
  $('#exportCSV').onclick=()=>{
    const rows=[['type','channel','at','link']].concat(LOG.map(x=>[x.type,x.channel||'',x.at||'',x.link||'']));
    const csv=rows.map(r=>r.map(v=>`"${(v||'').replace(/"/g,'""')}"`).join(',')).join('\n');
    const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.download='reviewlift-log.csv'; a.click();
  };
  $('#resetData').onclick=()=>{ if(confirm('Clear local data?')){ localStorage.removeItem(K.data); localStorage.removeItem(K.log); location.reload(); } };
}

// ===== Public page
function renderPublic(){
  const payload = location.hash.replace('#/p/','');
  const d = ub64(payload) || {n:'Your Business', c:'#4f46e5', l:'https://maps.google.com', msg: defaultMsg(), logo:''};
  document.body.style.background = 'linear-gradient(180deg,#f7f7fb,#eef2ff)';
  app.innerHTML = `
    <div class="public">
      <div class="panel">
        <div style="display:flex;align-items:center;gap:10px">
          ${d.logo? `<img src="${d.logo}" alt="logo" style="width:40px;height:40px;border-radius:8px">` : ''}
          <div style="font-weight:900;font-size:20px">${d.n}</div>
        </div>
        <div style="margin:10px 0;color:#475569">It only takes 30 seconds. Your feedback helps local customers find us. Thank you!</div>
        <div class="stack">
          <a class="btn" id="goBtn" style="text-decoration:none;display:inline-block;text-align:center;background:${d.c};color:#fff;border-radius:12px;padding:12px 14px;font-weight:800">Write a Google Review</a>
          <button id="copyInstr">Copy message</button>
        </div>
        <div class="hint" style="margin-top:8px">If the button doesn't open directly, tap “Reviews” then “Write a review” on Google.</div>
      </div>
    </div>`;
  $('#goBtn').href = d.l;
  $('#copyInstr').onclick=()=>{ navigator.clipboard.writeText((d.msg||defaultMsg()).replace('{firstName}','').replace('{visit}','visit').replace('{link}', d.l)); alert('Message copied'); };
}
</script>
</body>
</html>
